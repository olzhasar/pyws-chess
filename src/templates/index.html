<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css">
    <link rel="stylesheet" href="/static/css/main.css">

  </head>
  <body>
    <div class="container">
      <h1 id="gameStatus">Waiting for opponent...</h1>
      <div id="myBoard" style="width: 400px"></div>
    </div>
    <script src="/static/js/jquery-3.5.1.min.js"></script>

    <script src="/static/js/chessboard-1.0.0.min.js"></script>
    <script src="/static/js/chess.js"></script>
    <script>
    let config = {
      draggable: true,
      dropOffBoard: 'snapback', // this is the default
      orientation: 'white',
      position: 'start',
      onDrop: onDrop,
      onDragStart: onDragStart
    }

    let startTime;
    let board;
    const gameStatus = window.document.getElementById("gameStatus");
    const game = new Chess();
    let amIWhite = false;
    let myTurn = true;
    let myId;

    const ws = new WebSocket("ws://" + window.location.host + "/ws");

    ws.onopen = function() {
      console.log("Connected to server");
    }

    ws.onmessage = async function(event) {
      const data = JSON.parse(await event.data.text());
      console.debug(`Received message: ${JSON.stringify(data)}`);

      if (data.type === "GameStartResponse") {
	handleGameStart(data);
      } else if (data.type === "MoveResponse") {
	handleIncomingMove(data);
      } else {
	console.error(`Unknown message type: ${data.type}`);
      }
    };

    function handleGameStart(data) {
      startTime = new Date(data.start_time);
      console.debug(`Game started at: ${startTime.toLocaleString()}`);
      myId = data.my_id;
      amIWhite = data.am_i_white;

      if (!amIWhite) {
	config.orientation = 'black';
	myTurn = false;
      }

      board = Chessboard('myBoard', config);
    }

    function handleIncomingMove(data) {
	const source = data.uci.slice(0, 2);
	const target = data.uci.slice(2, 4);

	const move = game.move(
	  {
	    from: source,
	    to: target,
	    promotion: 'q'
	  }
	);
	if (move === null) {
	  console.error("Invalid opponent move");
	  return;
	}
	board.move(`${source}-${target}`);
	checkGameOver();

	myTurn = true;
    };

    function sendMove(uci) {
      const payload = {
	type: "MoveRequest",
	uci: uci
      }

      msg = JSON.stringify(payload);
      ws.send(msg);
      myTurn = false;

      console.debug(`Sent message: ${msg}`);
    }

    function onDragStart (source, piece, position, orientation) {
      if (!myTurn) return false
      if (game.game_over()) return false

      if ((orientation === 'white' && piece.search(/^w/) === -1) ||
	(orientation === 'black' && piece.search(/^b/) === -1)) {
	return false
      }
    }

    function checkGameOver() {
      if (!game.game_over()) {
	return;
      }

      let result;

      if (game.in_checkmate()) {
	if (myTurn) {
	  result = "You won by checkmate!";
	} else {
	  result = "Opponent wins by checkmate!";
	}

      } else if (game.in_draw()) {
	result = "Game ended in a draw!";
      }

      gameStatus.innerHTML = result;
    }

    function onDrop (source, target) {
      if (!myTurn) return 'snapback'

      if (source === target) return 'snapback'

      const move = game.move({
	from: source,
	to: target,
	promotion: 'q'
      })
      if (move === null) {
	console.debug("Invalid move");
	return 'snapback'
      }

      checkGameOver();

      const uci = `${source}${target}`

      console.debug(`Detected move: ${uci}`);

      sendMove(uci)
    }


    </script>
  </body>
</html>
