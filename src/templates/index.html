<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css">
    <link rel="stylesheet" href="/static/css/main.css">

  </head>
  <body>
    <div class="container">
      <h1 id="gameStatus">Waiting for opponent...</h1>
      <div id="myBoard" style="width: 400px"></div>
    </div>
    <script src="/static/js/jquery-3.5.1.min.js"></script>

    <script src="/static/js/chess.js"></script>
    <script src="/static/js/chessboard-1.0.0.min.js"></script>
    <script>
    let config = {
      draggable: true,
      dropOffBoard: 'snapback', // this is the default
      orientation: 'white',
      position: 'start',
      onDrop: onDrop
    }

    let startTime;
    let board;
    const gameStatus = window.document.getElementById("gameStatus");
    const game = new Chess();
    let amIWhite = false;

    const ws = new WebSocket("ws://" + window.location.host + "/ws");

    ws.onopen = function() {
      console.log("Connected to server");
    }

    ws.onmessage = async function(event) {
      const data = JSON.parse(await event.data.text());
      if (data.type === "GameStartResponse") {
	startTime = new Date(data.start_time);
	gameStatus.innerHTML = startTime.toLocaleString();
	amIWhite = data.am_i_white;

	if (!amIWhite) {
	  config.orientation = 'black';
	}

	board = Chessboard('myBoard', config);

      } else {
	gameStatus.innerHTML = data;
	console.log(data);
      }
    };

    function sendMove(uci) {
      const payload = {
	type: "MoveRequest",
	uci: uci
      }

      ws.send(JSON.stringify(payload));
      console.log(`Sent move: ${payload}`);
    }

    function onDrop (source, target) {
      // check if the move is legal
      var move = game.move({
	from: source,
	to: target,
	promotion: 'q'
      })

      // illegal move
      if (move === null) return 'snapback'

      const uci = `${source}${target}`

      sendMove(uci)
    }


    </script>
  </body>
</html>
